---

- name: create ecs
  cloudformation:
    stack_name: "{{ env }}-{{ application_name }}-ecs-stack"
    state: present
    region: "{{ aws_region }}"
    template: "{{ ecs_cfn_template }}"
    template_parameters:
      ApplicationName : "{{ application_name }}"
      Environment: "{{ env }}"
      InstanceType: "{{ ecs.instance_type }}"
      KeyPair: "{{ ecs.key_pair }}"
      SecurityGroup: "{{ ecs.security_group | default('') }}"
      ClusterSize: "{{ ecs.cluster_size }}"
      Subnets: "{{ ecs.subnets }}"
      ClusterName: "{{ ecs.cluster_name }}"
      InstanceNameTag: "{{ ecs.instance_name_tag }}"
      VpcId: "{{ vpc_id }}"
  environment:
    AWS_ACCESS_KEY_ID: "{{  assumed_role.sts_creds.access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ assumed_role.sts_creds.secret_key }}"
    AWS_SESSION_TOKEN: "{{ assumed_role.sts_creds.session_token }}"